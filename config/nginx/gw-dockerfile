FROM nginx:latest

ARG http_server_port=8000
ARG tcp_server_port=1884
ARG timer_server_port=9000
ARG proxy_server_host=localhost
ARG proxy_http_server_port=80
ARG proxy_https_server_port=443
ARG proxy_mqtt_broker_port=1883
ARG proxy_mqtts_broker_port=8883
ARG nginx_template=./aloes-gw.template

ENV HTTP_SERVER_PORT=${http_server_port}
ENV TCP_SERVER_PORT=${tcp_server_port}
ENV TIMER_SERVER_PORT=${timer_server_port}
ENV PROXY_SERVER_HOST=${proxy_server_host}
ENV PROXY_HTTP_SERVER_PORT=${proxy_http_server_port}
ENV PROXY_HTTPS_SERVER_PORT=${proxy_https_server_port}
ENV PROXY_MQTT_BROKER_PORT=${proxy_mqtt_broker_port}
ENV PROXY_MQTTS_BROKER_PORT=${proxy_mqtts_broker_port}
ENV NGINX_TEMPLATE=${nginx_template}

RUN echo "HTTP_SERVER $HTTP_SERVER_PORT"
RUN echo "TCP_SERVER_PORT $TCP_SERVER_PORT"
RUN echo "PROXY_SERVER_HOST $PROXY_SERVER_HOST"
RUN echo "NGINX_TEMPLATE $NGINX_TEMPLATE"

RUN rm /etc/nginx/conf.d/default.conf
COPY ${NGINX_TEMPLATE} /etc/nginx/nginx.template

RUN mkdir -p /var/www/certbot
RUN mkdir /etc/letsencrypt

RUN ln -sf /dev/stdout /var/log/nginx/http-gw-access.log && ln -sf /dev/stderr /var/log/nginx/http-gw-error.log
RUN ln -sf /dev/stdout /var/log/nginx/mqtt-gw-access.log && ln -sf /dev/stderr /var/log/nginx/mqtt-gw-error.log

EXPOSE ${PROXY_HTTP_SERVER_PORT}
EXPOSE ${PROXY_MQTT_BROKER_PORT}
EXPOSE ${PROXY_HTTPS_SERVER_PORT}
EXPOSE ${PROXY_MQTTS_BROKER_PORT}

CMD envsubst '$${HTTP_SERVER_PORT},$${TCP_SERVER_PORT},${TIMER_SERVER_PORT},$${PROXY_MQTT_BROKER_PORT},$${PROXY_MQTTS_BROKER_PORT},$${PROXY_HTTP_SERVER_PORT},$${PROXY_HTTPS_SERVER_PORT},$${PROXY_SERVER_HOST}' \
	< /etc/nginx/nginx.template > /etc/nginx/nginx.conf ; while :; do sleep 6h & wait ${!}; nginx -s reload; done & nginx -g 'daemon off;'

# ; while :; do sleep 6h & wait ${!}; nginx -s reload; done & nginx -g 'daemon off;